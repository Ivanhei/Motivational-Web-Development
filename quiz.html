<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>A Pen by Ivan</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.2/tailwind.min.css"
    />
  </head>

  <body translate="no">
    <div id="mainApp">
      <!-- Content Generated by JS -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script id="rendered-js" type="text/babel">
      const challenges = [
        /*
  {
    // meta
    metadata: {
      type: "multi_choices" | "general_slotted_choices",
      subtype: "definitions" | "abbreviations" | "audio_select",
      id: <string>,
      difficulty: <int from 0 to 100>,
      has_audio: true | false,
      keywords: ["GPU", "graphics", "processing"]
    }
    
    // question
    prompt: {
      main_text: "What is GPU?",
      sub_text: "",
      audio: {
        URL: "https://..."
      },
    },
    
    // answer
    choices: [
      {text: "Graphics Processing Unit", japanese: "グラフィックス プロセッシング ユニット"}, 
      {text: "Global Positioning Union", japanese: "全地球測位連合"}, 
      {text: "Graphical Package Unit", japanese: "グラフィカル パッケージ ユニット"}, 
      {text: "Graphics Platform Unit", japanese: "グラフィック プラットフォーム ユニット"}
    ] | [
      {text: "Graphics", japanese: "グラフィックス"}, 
      {text: "Global", japanese: "全地球"}, 
      {text: "Graphical", japanese: "グラフィカル"}, 

      {text: "Processing", japanese: "プロセッシング"}, 
      {text: "Positioning", japanese: "測位"}, 
      {text: "Package", japanese: "パッケージ"}, 
      {text: "Platform", japanese: "プラットフォーム"}, 

      {text: "Unit", japanese: "ユニット"}, 
      {text: "Union", japanese: "連合"}, 
    ],
    correctSolutions: ["Graphics Processing Unit"],
    correctTokens: ["Graphics", "Processing", "Unit"],
  },
  */

        {
          // meta
          metadata: {
            type: "multi_choices",
            subtype: "abbreviations",
            id: "0",
            difficulty: 30,
            has_audio: false,
            keywords: ["GPU", "graphics", "processing"]
          },

          // question
          prompt: {
            main_text: "What is GPS?",
            sub_text: "Please choose the correct phrase for the abbreviation."
          },

          // answer
          choices: [
            { text: "Graphics", japanese: "グラフィックス" },
            { text: "Global", japanese: "全地球" },
            { text: "Graphical", japanese: "グラフィカル" },

            { text: "Processing", japanese: "プロセッシング" },
            { text: "Positioning", japanese: "測位" },
            { text: "Package", japanese: "パッケージ" },
            { text: "Platform", japanese: "プラットフォーム" },

            { text: "Scale", japanese: "尺度" },
            { text: "System", japanese: "系統" },
            { text: "Scale", japanese: "尺度" },
            { text: "System", japanese: "系統" }
          ],
          correctTokensList: [["Global", "Positioning", "System"]]
        },
        {
          // meta
          metadata: {
            type: "multi_choices",
            subtype: "abbreviations",
            id: "0",
            difficulty: 30,
            has_audio: false,
            keywords: ["GPU", "graphics", "processing"]
          },

          // question
          prompt: {
            main_text: "What is GPU?",
            sub_text: "Please choose the correct phrase for the abbreviation."
          },

          // answer
          choices: [
            { text: "Graphics", japanese: "グラフィックス" },
            { text: "Global", japanese: "全地球" },
            { text: "Graphical", japanese: "グラフィカル" },

            { text: "Processing", japanese: "プロセッシング" },
            { text: "Positioning", japanese: "測位" },
            { text: "Package", japanese: "パッケージ" },
            { text: "Platform", japanese: "プラットフォーム" },

            { text: "Unit", japanese: "ユニット" },
            { text: "Union", japanese: "連合" }
          ],
          correctTokensList: [
            ["Graphical", "Processing", "Unit"],
            ["Graphics", "Processing", "Unit"]
          ]
        }
      ];

      // state
      const NOT_ANSWERED_YET = -1;
      const ANSWER_INCORRECT = 0;
      const ANSWER_CORRECT = 1;

      function Challenge(props) {
        const challenge = props.challenge;
        const [answer, setAnswer] = React.useState([]);
        const [showHint, setShowHint] = React.useState(false);
        const [disabledChoice, setDisabledChoice] = React.useState([]);

        const [answerState, setAnswerStateInternal] = React.useState(
          NOT_ANSWERED_YET
        );
        // format: {choiceIndex: <int>, text: <string>}

        function setAnswerState(newState) {
          setAnswerStateInternal(newState);
          props.onAnswer(newState);
        }

        function removeFromAnswer(item, i) {
          setDisabledChoice((disabledChoice) =>
            disabledChoice.filter((index) => index !== item.choiceIndex)
          );
          setAnswer((answer) => answer.filter((item_) => item_ !== item));
          setAnswerState(NOT_ANSWERED_YET);
        }

        function pushToAnswer(choice, i) {
          setAnswer([
            ...answer,
            { choiceIndex: i, text: choice.text, japanese: choice.japanese }
          ]);
          setDisabledChoice((disabledChoice) => [...disabledChoice, i]);
          setAnswerState(NOT_ANSWERED_YET);
        }

        function checkAnswer() {
          // multiple answers
          for (let j = 0; j < challenge.correctTokensList.length; j++) {
            const correctTokens = challenge.correctTokensList[j];
            // length match
            if (correctTokens.length !== answer.length) continue;

            // deep match
            let matchFlag = true;
            for (let i = 0; i < answer.length; i++)
              if (correctTokens[i] !== answer[i].text) {
                matchFlag = false;
                break;
              }
            if (matchFlag === false) continue;

            return true;
          }
          return false;
        }

        return (
          <div>
            <h2>{challenge.prompt.main_text}</h2>
            <div>
              {challenge.prompt.sub_text}
              <button
                onClick={(e) => {
                  setShowHint((sh) => !sh);
                }}
                style={{ margin: "5px" }}
              >
                {showHint ? "Hide" : "Get"} hint.
              </button>
            </div>
            <div style={{ border: "2px solid #aaa" }}>
              <div>
                Answer:{" "}
                {answer.map((item, i) => (
                  <button
                    style={{ margin: "5px" }}
                    onClick={(e) => removeFromAnswer(item, i)}
                  >
                    {showHint ? item.japanese : item.text}
                  </button>
                ))}
              </div>
              <div>
                <button
                  style={{ margin: 5 }}
                  disabled={answer.length === 0}
                  onClick={(e) => {
                    setAnswerState(
                      checkAnswer() ? ANSWER_CORRECT : ANSWER_INCORRECT
                    );
                  }}
                >
                  answer
                </button>
                <button
                  style={{ margin: 5 }}
                  disabled={answer.length === 0}
                  onClick={(e) => {
                    answer.forEach(removeFromAnswer);
                  }}
                >
                  clear
                </button>
                {answerState === ANSWER_INCORRECT
                  ? "Wrong Answer. "
                  : answerState === ANSWER_CORRECT
                  ? "Correct Answer."
                  : ""}
              </div>
            </div>
            <div style={{ border: "2px solid #0af", marginTop: 1 }}>
              Choices:{" "}
              {challenge.choices.map((choice, i) => (
                <button
                  disabled={disabledChoice.includes(i)}
                  style={{ margin: "5px" }}
                  onClick={(e) => pushToAnswer(choice, i)}
                >
                  {showHint ? choice.japanese : choice.text}
                </button>
              ))}
            </div>
          </div>
        );
      }

      function Congratulations(props) {
        return (
          <div>
            <h2>Congratulations!</h2>
            <div>You have completed the quiz!</div>
          </div>
        );
      }

      function App() {
        const [pageNum, setPageNum] = React.useState(0);
        const [progress, setProgress] = React.useState(0);
        const [answerState, setAnswerState] = React.useState(NOT_ANSWERED_YET);

        return (
          <div>
            <nav class="flex m-5 p-10">
              <div
                class="flex-grow"
                style={{
                  height: 20,
                  border: "2px solid #aaa",
                  borderRadius: 10
                }}
              >
                <div
                  style={{
                    background: "#ccc",
                    height: "100%",
                    width: progress * 100 + "%",
                    borderRadius: 10,
                    transition: ".5s"
                  }}
                />
              </div>
            </nav>
            {pageNum < challenges.length ? (
              <Challenge
                challenge={challenges[pageNum]}
                onAnswer={(answer_state) => {
                  setAnswerState(answer_state);
                  if (answer_state == ANSWER_CORRECT)
                    setProgress((pageNum + 1) / challenges.length);
                }}
              />
            ) : (
              <Congratulations />
            )}

            <button
              disabled={answerState !== ANSWER_CORRECT}
              onClick={(e) => {
                setAnswerState(NOT_ANSWERED_YET);
                setProgress((pageNum + 1) / challenges.length);
                setPageNum((num) => num + 1);
              }}
            >
              {pageNum + 1 < challenges.length ? "Go to Next" : "Complete Quiz"}
            </button>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("mainApp"));
    </script>
  </body>
</html>
