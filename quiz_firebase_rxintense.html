<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>A Pen by Ivan</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.2/tailwind.min.css"
    />
    <style>
      * {
        /*font-family: 'Rubik', sans-serif;*/
        color: #333333;
        font-size: 17px;
        font-family: Comic Sans MS;
      }
      button,
      .button,
      input,
      input:focus,
      input.answered {
        color: #000;
        border: 2px solid #b4b4b4;
        padding: 0.5rem 2rem;
        margin: 0rem 0.75rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      button:focus,
      input:focus {
        outline: none;
      }
      button[disabled],
      button.selected {
        color: rgb(91, 200, 255);
        border-color: rgb(91, 200, 255);
        background: rgba(91, 200, 255, 0.03);
        box-shadow: 0 4px 6px -1px rgba(91, 200, 255, 0.1),
          0 0px 5px rgba(91, 200, 255, 0.25);
        text-shadow: 0 0px 5px rgba(91, 200, 255, 0.25);
      }
      button.correct,
      input.correct {
        color: rgb(52, 212, 105);
        border-color: rgb(77, 231, 128);
        background: rgba(77, 231, 128, 0.03);
        box-shadow: 0 4px 6px -1px rgba(77, 231, 128, 0.1),
          0 0px 5px rgba(77, 231, 128, 0.25);
        text-shadow: 0 0px 5px rgba(77, 231, 128, 0.25);
      }
      button.incorrect,
      input.incorrect {
        color: #ff7676;
        border-color: #ff7676;
        background: rgba(255, 118, 118, 0.03);
        box-shadow: 0 4px 6px -1px rgba(255, 118, 118, 0.1),
          0 0px 5px rgba(255, 118, 118, 0.25);
        text-shadow: 0 0px 5px rgba(255, 118, 118, 0.25);
      }
      button.play {
        border-color: rgb(236, 225, 71);
        background: rgba(236, 225, 71);
        box-shadow: 0 4px 6px -1px rgba(236, 225, 71, 0.1),
          0 0px 5px rgba(236, 225, 71, 0.25);
        text-shadow: 0 0px 5px rgba(236, 225, 71, 0.25);
        border-radius: 100%;
        margin-bottom: 60px;
      }
      button.play path {
        fill: #fff;
      }
      main {
        padding: 0 10px;
      }
    </style>
  </head>

  <body translate="no">
    <div id="mainApp" class="h-screen">
      <!-- Content Generated by JS -->
    </div>

    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-storage.js"></script>

    <!-- RxJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.1.0/rxjs.umd.min.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyDBORguQ4fUIgHevka4CiC-M44DM5DoBLQ",
        authDomain: "gt-uoa.firebaseapp.com",
        projectId: "gt-uoa",
        storageBucket: "gt-uoa.appspot.com",
        messagingSenderId: "990838040454",
        appId: "1:990838040454:web:25634085dc0b6184696e07"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
    </script>

    <script id="rendered-js" type="text/babel">
      // https://stackoverflow.com/a/19270021
      function getRandomFromArray(arr, n) {
        var result = new Array(n),
          len = arr.length,
          taken = new Array(len);
        if (n > len)
          throw new RangeError("getRandom: more elements taken than available");
        while (n--) {
          var x = Math.floor(Math.random() * len);
          result[n] = arr[x in taken ? taken[x] : x];
          taken[x] = --len in taken ? taken[len] : len;
        }
        return result;
      }
      const iconCross = (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="100%"
          /*width="30.708"
          height="30.708"*/
          viewBox="0 0 30.708 30.708"
        >
          <path
            id="Icon_material-close"
            data-name="Icon material-close"
            d="M38.208,10.593,35.115,7.5,22.854,19.761,10.593,7.5,7.5,10.593,19.761,22.854,7.5,35.115l3.093,3.093L22.854,25.947,35.115,38.208l3.093-3.093L25.947,22.854Z"
            transform="translate(-7.5 -7.5)"
            fill="#707070"
          />
        </svg>
      );
      const useObservable = (observable) => {
        const [value, setValue] = React.useState();

        React.useEffect(() => {
          const subscription = observable.subscribe((v) => {
            setValue(v);
          });

          return () => {
            subscription.unsubscribe();
          };
        }, [observable]);

        return value;
      };

      // state
      const NOT_ANSWERED_YET = -1;
      const ANSWER_INCORRECT = 0;
      const ANSWER_CORRECT = 1;
      const subjects = {
        answerState: new rxjs.BehaviorSubject(NOT_ANSWERED_YET),
        answerButton: new rxjs.Subject(),
        nextButton: new rxjs.Subject(),
        hintButton: new rxjs.Subject()
      };
      const nexts = {
        answerState: (x) => subjects.answerState.next(x),
        answerButton: () => subjects.answerButton.next(),
        nextButton: () => subjects.nextButton.next(),
        hintButton: () => subjects.hintButton.next()
      };
      const observables = {
        answerState: () => subjects.answerState.asObservable(),
        answerButton: () => subjects.answerButton.asObservable(),
        nextButton: () => subjects.nextButton.asObservable(),
        hintButton: () => subjects.hintButton.asObservable()
      };

      const Challenge = (props, ref) => {
        const challenge = props.challenge;
        const [answer, setAnswer] = React.useState("");
        const [showHint, setShowHint] = React.useState(false);
        const [disabledChoice, setDisabledChoice] = React.useState([]);

        function checkAnswer() {
          console.log(challenge.answer, "===", answer);
          if (challenge.type === "mc") return challenge.answer === answer;
          else return challenge.answer.toLowerCase() === answer.toLowerCase();
        }

        //region answerState + setAnswerState replaced with observerable
        const [answerState, answerStateSetter] = React.useState(
          NOT_ANSWERED_YET
        );

        React.useEffect(() => {
          const subscription = //new rxjs.Subscription();
            // subscription.add(
            observables.answerState().subscribe(answerStateSetter);
          // );

          // additional: answer button press
          subscription.add(
            observables.answerButton().subscribe(() => {
              const answer_state = checkAnswer()
                ? ANSWER_CORRECT
                : ANSWER_INCORRECT;
              setAnswerState(answer_state);
              if (answer_state == ANSWER_CORRECT) props.onCorrect();
            })
          );

          // additional: next button press
          subscription.add(
            observables.nextButton().subscribe(() => {
              setAnswer("");

              // change to next page
              setAnswerState(NOT_ANSWERED_YET);
              props.onNext();
            })
          );

          return () => {
            console.log("unsub");
            subscription.unsubscribe();
          };
        }, []);

        const setAnswerState = (x) => nexts.answerState(x);
        //endregion

        const audioRef = React.useRef();

        React.useEffect(() => {
          audioRef.current.play();

          console.log(challenge);
        }, [challenge]);

        const correctAudioRef = React.useRef();
        const incorrectAudioRef = React.useRef();

        React.useEffect(() => {
          if (answerState === ANSWER_CORRECT) {
            correctAudioRef.current.volume = 0.1;
            correctAudioRef.current.play();
          } else if (answerState === ANSWER_INCORRECT) {
            incorrectAudioRef.current.volume = 0.1;
            incorrectAudioRef.current.play();
          }
        }, [answerState]);

        return (
          <div>
            <audio src="assets/sounds/fairy.wav" ref={correctAudioRef} />
            <audio src="assets/sounds/wrong.wav" ref={incorrectAudioRef} />
            <div class="flex-grow text-center p-10 px-40 lg:px-60 xl:px-80">
              <h2>{/*challenge.prompt.main_text*/}</h2>
              <div>Play the audio. Choose the vocabulary you listened.</div>
              <div>
                <audio src={challenge.audio_url} ref={audioRef} />
                {challenge.audio_url ? (
                  <button
                    class="p-4 play w-20 p-4"
                    onClick={(e) => {
                      audioRef.current.play();
                    }}
                  >
                    <svg
                      viewBox="0 0 100 100"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <rect width="100" height="100" />
                      <path
                        d="M100 50L25 93.3013L25 6.69873L100 50Z"
                        fill="#FF7676"
                      />
                    </svg>
                  </button>
                ) : (
                  <div style={{ color: "red" }}>
                    Error while fetching audio.
                  </div>
                )}
              </div>
              <div></div>
              <div
                style={{
                  marginTop: 10,
                  marginBottom: 10
                }}
              >
                {challenge.type === "mc" ? (
                  challenge.options.map((option, i) => (
                    <button
                      class={
                        "" +
                        (answer === option
                          ? answerState === ANSWER_CORRECT
                            ? "correct"
                            : answerState === ANSWER_INCORRECT
                            ? "incorrect"
                            : "selected"
                          : "")
                      }
                      onClick={(e) => setAnswer(option)}
                      style={{ margin: 10, width: "50%" }}
                    >
                      {option}
                    </button>
                  ))
                ) : (
                  // challenges[pageNum].type === "spelling"
                  <input
                    onChange={(e) => {
                      setAnswer(event.target.value);
                    }}
                    class={
                      "" +
                      (answer.length > 0
                        ? answerState === ANSWER_CORRECT
                          ? "correct"
                          : answerState === ANSWER_INCORRECT
                          ? "incorrect"
                          : "answered"
                        : "")
                    }
                    value={answer}
                  />
                )}
              </div>
            </div>
          </div>
        );
      };

      function AnswerBox(props) {
        //region answerState + setAnswerState replaced with observerable
        const [answerState, answerStateSetter] = React.useState(
          NOT_ANSWERED_YET
        );

        React.useEffect(() => {
          const subscription = observables
            .answerState()
            .subscribe(answerStateSetter);

          return () => {
            subscription.unsubscribe();
          };
        }, []);

        const setAnswerState = (x) => nexts.answerState(x);
        //endregion

        return (
          <div class="flex my-20 flex-cols align-middle items-center">
            <div class="flex-grow"></div>
            <button
              class=""
              onClick={
                (e) => {
                  nexts.hintButton();
                }
                //(e) => setShowHint((sh) => !sh)
              }
            >
              Hint
            </button>
            <div class="flex-grow"></div>
            {answerState === NOT_ANSWERED_YET ? (
              <button
                class="block"
                // disabled={!challengeRef.current.answerable()}
                onClick={(e) => {
                  nexts.answerButton();
                }}
              >
                answer
              </button>
            ) : (
              <button
                class="block"
                onClick={(e) => {
                  nexts.nextButton();
                }}
              >
                {props.isLastQuestion ? "Complete Quiz" : "Go to Next"}
              </button>
            )}
            <div class="flex-grow"></div>
          </div>
        );
      }

      function Congratulations(props) {
        const celebrationAudioRef = React.useRef();

        React.useEffect(() => {
          celebrationAudioRef.current.play();
        }, []);

        return (
          <div>
            <audio src="assets/sounds/finish.wav" ref={celebrationAudioRef} />
            <h2>Congratulations!</h2>
            <div>You have completed the quiz!</div>
          </div>
        );
      }

      function App() {
        const [pageNum, setPageNum] = React.useState(0);
        const [progress, setProgress] = React.useState(0);

        const challengeRef = React.useRef();

        const [challenges, setChallenges] = React.useState([]);
        const [loaded, setLoaded] = React.useState(false);

        // React.useEffect(() => {
        //   db.collection("problems")
        //     .get()
        //     .then((querySnapshot) =>
        //       Promise.all(
        //         querySnapshot.docs.map((doc) =>
        //           storage
        //             .ref()
        //             .child(doc.data().audio)
        //             .getDownloadURL()
        //             .then((url) => ({
        //               ...doc.data(),
        //               id: doc.id,
        //               audio_url: url
        //             }))
        //             .catch((err) => {
        //               console.log("Error while getting Audio URL. ", err);

        //               return {
        //                 ...doc.data(),
        //                 id: doc.id
        //               };
        //             })
        //         )
        //       )
        //     )
        //     .then((challenges) => {
        //       console.log(challenges);
        //       setChallenges(challenges);
        //       setLoaded(true);
        //     })
        //     .catch((error) => {
        //       console.error("Error ocurred while parsing challenges. ", error);
        //     });

        //   return () => {};
        // }, []);

        React.useEffect(() => {
          rxjs
            .from(db.collection("problems").get())
            .pipe(
              rxjs.operators.map((querySnapshot) =>
                querySnapshot.docs.map((doc) => ({
                  ...doc.data(),
                  id: doc.id
                }))
              )
            )
            .pipe(
              rxjs.operators.mergeMap(async (docs) => {
                return Promise.all(
                  docs.map((doc) =>
                    storage
                      .ref()
                      .child(doc.audio)
                      .getDownloadURL()
                      .then((url) => ({
                        ...doc,
                        audio_url: url
                      }))
                      .catch((err) => {
                        console.log("Error while getting Audio URL. ", err);

                        return doc;
                      })
                  )
                );
              })
              // rxjs.operators.mergeMap(async (doc) => {
              //   let url = "";
              //   try {
              //     url = await storage.ref().child(doc.audio).getDownloadURL();
              //   } finally {
              //   }

              //   return {
              //     ...doc,
              //     audio_url: url
              //   };
              // })
            )
            .subscribe((challenges) => {
              setChallenges(
                challenges.length > 10
                  ? getRandomFromArray(challenges, 10)
                  : challenges
              );
              setLoaded(true);
            });

          return () => {};
        }, []);

        return (
          <div class="flex flex-col h-screen">
            <nav class="flex mt-16 mb-36 items-center">
              <div class="flex-grow"></div>
              <div
                style={{
                  height: 20,
                  background: "#F1EEEE",
                  borderRadius: 10,
                  opacity: loaded ? 1 : 0,
                  transition: ".5s",
                  width: "60%"
                }}
              >
                <div
                  style={{
                    background: "#7AF16C",
                    height: "100%",
                    width: progress * 100 + "%",
                    borderRadius: 10,
                    transition: ".5s"
                  }}
                />
              </div>
              <div
                class="flex-grow"
                style={{
                  height: 20, // for svg icon to get same height as progress bar
                  paddingLeft: 40
                }}
              >
                <a href="index.html">{iconCross}</a>
              </div>
            </nav>
            <main>
              {pageNum < challenges.length ? (
                <Challenge
                  ref={challengeRef}
                  challenge={challenges[pageNum]}
                  isLastQuestion={pageNum === challenges.length - 1}
                  onCorrect={() => {
                    setProgress((progress) => progress + 1 / challenges.length);
                  }}
                  onNext={() => {
                    setPageNum((pageNum) => pageNum + 1);
                  }}
                />
              ) : (
                <div class="px-40 lg:px-60 xl:px-80 text-center">
                  {loaded ? (
                    <Congratulations />
                  ) : (
                    <svg
                      version="1.1"
                      id="loader-1"
                      xmlns="http://www.w3.org/2000/svg"
                      x="0px"
                      y="0px"
                      viewBox="0 0 50 50"
                      style={{
                        enableBackground: "new 0 0 50 50",
                        width: "100%",
                        maxWidth: "72px",
                        display: "inline-block"
                      }}
                    >
                      <path
                        fill="#000"
                        d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z"
                      >
                        <animateTransform
                          attributeType="xml"
                          attributeName="transform"
                          type="rotate"
                          from="0 25 25"
                          to="360 25 25"
                          dur="0.6s"
                          repeatCount="indefinite"
                        />
                      </path>
                    </svg>
                  )}
                </div>
              )}
            </main>

            <AnswerBox />
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("mainApp"));
    </script>
  </body>
</html>
